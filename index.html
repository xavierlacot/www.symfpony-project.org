<!DOCTYPE html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
	<meta charset="UTF-8">

  <title>Symfpony-Project.org - REST webservice with symfony1 &amp; Symfony2</title>

	<meta name="description" content="Differences between symfony 1 and Symfony2 on a REST webservice application.">
	<meta name="author" content="Xavier Lacot, Damien Alexandre">

	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="shortcut icon" href="favicon.ico">

  <link href="syntaxhighlighter/styles/shCore.css" type="text/css" rel="stylesheet" />
  <link href="syntaxhighlighter/styles/shThemeFadeToGrey.css" type="text/css" rel="stylesheet" />
	<link rel="stylesheet" href="/css/style.css?v=2">


	<!--[if lt IE 9]>
	<script src="js/libs/html5shiv.js"></script>
	<![endif]-->
</head>
<body>

  <div id="header-container">
		<header class="wrapper">

      <img src="images/pony.png" alt="Pony" class="png_bg" />
			<h1 id="title"><a href="./">Symf<span>(</span>p<span>)</span>ony-Project.org</a></h1>
      <img src="images/logo.png" alt="Symfpony logo" class="png_bg" />
      
			<nav>
				<ul>
					<li><a href="#t_routing">Routing</a></li>
					<li><a href="#t_validation">Validation</a></li>
          <li><a href="#t_format">Output &amp; format</a></li>
          <li><a href="#t_cache">Caching ressources</a></li>
				</ul>
			</nav>
		</header>
	</div>
	<div id="main" class="wrapper">

    <article>
      <p>This page is part of our Symfony Live 2011 talk about REST webservices with symfony and Symfony2.<br />
      There is major differences between the two framework, both can be list as RESTful but implementations are differents.<br />
      The aim of this page is to compare the frameworks best pratices / out of the box solutions for creating a REST web service over HTTP.</p>
    </article>


		<article>
			<header>
				<h2 id="t_routing">Routing</h2>
				<p>The component in charge of finding the right controller to execute from a browser request.</p>
			</header>
      <div class="symfony">
        <h3>symfony</h3>
        <p>The routing of symfony is quite powerfull. You can use different matching / generating classes (like <strong>sfDoctrineRoute</strong>), generate route collections...</p>
        
        <pre class="brush: yaml; gutter: false;">
          pony_list:
            url: /pony.:sf_format
            param: { module: pony, action: index, sf_format: xml }
            class: sfRequestRoute
            requirements: { sf_method: GET, sf_format: (xml|json|yml) }

          pony_show:
            url: /pony/:slug.:sf_format
            param: { module: pony, action: show, sf_format: xml }
            class: sfDoctrineRoute
            options: { model: Pony, column: slug, type: object }
            requirements: { sf_method: GET, sf_format: (xml|json|yml) }
        </pre>
      </div>
      <div class="symfony2">
        <h3>Symfony2</h3>
				<p>The Router component is quite simpler than the symfony one's, it's all about matching pattern and generating URL <strong>ONLY</strong>.</p>
        <p>Here is the configuration file, nothing much to say about it, but look at the <strong>_controller</strong> parameter: no more action / module - you just
          declare a callable controller - can be anything, even a static method from a custom class.</p>

        <pre class="brush: yaml; gutter: false;">
          pony_list:
              pattern:      /pony.{_format}
              defaults:     { _controller: CleverAgeSymfponyBundle:Default:index, _format: xml }
              requirements: { _format: (xml|json), _method: GET }

          pony_show:
              pattern:      /pony/{slug}.{_format}
              defaults:     { _controller: CleverAgeSymfponyBundle:Default:show, _format: xml }
              requirements: { _format: (xml|json), _method: GET, slug: "[a-z0-9-]+" }
        </pre>

        <p>
          Take a look at <a href="http://bundles.symfony-reloaded.org/frameworkextrabundle/annotations/converters.html">ParamConverter</a> if you want a sfDoctrineRoute-like input.
        </p>
      </div>
      <footer>
        <h3>Conclusion</h3>
				<p>Routers doesn't have the same philosophy but their configurations are quite similar.</p>
			</footer>
		</article>

    
		<article>
			<header>
				<h2 id="t_validation">Validation</h2>
				<p>The Validation process has been entirely refactored from symfony.</p>
			</header>
      <div class="symfony">
        <h3>symfony</h3>
        <p>There is two validators declaration: one in sfForm, the other in Doctrine. They can't work together so we useally use the sfValidators from sfForm.</p>

        <pre class="brush: php; gutter: false;">
          $pony_form = new PonyForm();
          
          $pony_form->bind($values);

          if ($pony_form->isValid())
          {
            // You can save the Pony here
          }
        </pre>
      </div>
      <div class="symfony2">
        <h3>Symfony2</h3>
				<p>You define the fields validators directly from your Entities, or any other Class, or even from Yaml / Xml / Php file. Write once, use anywhere.</p>

        <pre class="brush: php; gutter: false;">
          class Pony
          {
              /**
               * @var integer $id
               *
               * @orm:Column(name="id", type="integer")
               * @orm:Id
               * @orm:GeneratedValue(strategy="IDENTITY")
               */
              private $id;

              /**
               * @var string $name
               *
               * @gedmo:Sluggable
               * @orm:Column(name="name", type="string", length=110)
               * @validation:NotBlank()
               * @validation:MinLength(3)
               */
              private $name;
        </pre>
        <pre class="brush: php; gutter: false;">
          $validator = $this->get('validator');

          if (0 === count($validator->validate($pony)))
          {
            // Pony is valid \o/
          }
        </pre>

        <p>
          There is a lot more to say about validation, don't hesitate to take a look at the whole <a href="https://github.com/xavierlacot/symfpony-project.org">SymfponyBundle</a> and the <a href="http://docs.symfony-reloaded.org/guides/validator/overview.html">official documentation</a>.
        </p>
      </div>
      <footer>
        <h3>Conclusion</h3>
				<p>Validation is supported by both frameworks, again with two differents philosophies.</p>
			</footer>
		</article>


    <article>
			<header>
				<h2 id="t_format">Output format</h2>
				<p>There is no true serializer in symfony, but Symfony2 introduce a Serializer component. Here is how to encode in Xml Pony in both of them.</p>
			</header>
      <div class="symfony">
        <h3>symfony</h3>
        <p>As there is no Serializer component, we must use the Doctrine Dumper. It works fine but we will not be able to customize it.</p>
        <pre class="brush: php; gutter: false;">
          $query = // New DoctrineQuery fetching some ponies!
          $query->execute()->exportTo('xml');
        </pre>
        <p>
          It's quick &amp; dirty, there is no CDATA, no namespace... But it's the only solution out of the box.<br />
          You can use <strong>Doctrine_Parser::load</strong> and <strong>fromArray()</strong> to reverse the process.
        </p>
      </div>
      <div class="symfony2">
        <h3>Symfony2</h3>
				<p>Introducing the new Serializer component, composed of Normalizers and Encoders:<br />
          the Normalizer transform Entities into php array, and the encoder... encode them into Json or Xml.</p>

        <pre class="brush: php; gutter: false;">
          use Symfony\Component\Serializer;

          // Init the Serializer
          $serializer = new Serializer\Serializer();
          $serializer->addNormalizer(new Serializer\Normalizer\CustomNormalizer());
          $serializer->setEncoder('xml', new Serializer\Encoder\XmlEncoder());

          $xml_pony = $serializer->encode($pony, 'xml'); // Return an XML string

          $pony_from_xml = $serializer->denormalizeObject( // Return a Pony instance
            $serializer->decode($xml_pony, 'xml'), // Return an array from the XML
            'CleverAge\SymfponyBundle\Entity\Pony',
            'xml'
          );
        </pre>
      </div>
      <footer>
        <h3>Conclusion</h3>
				<p>If you can, take the Symfony2 Serializer component into your symfony 1 webservice (you only need PHP 5.3).</p>
			</footer>
		</article>


    <article>
			<header>
				<h2 id="t_caching">Caching your Ressources</h2>
				<p>Caching is realy important. You must set it up, even for a short time. Your server charge will definitelly thank you.</p>
			</header>
      <div class="symfony">
        <h3>symfony</h3>
        <p>The full page cache is setted in each application cache.yml and activated in settings.yml. Ressources will be stored on your serveur harddrive but
        you can specify a custom store, like Memcached.</p>
        <pre class="brush: yml; gutter: false;">
          # settings.yml
          prod:
            .settings:
              no_script_name:         true
              cache:                  false

          # cache.yml
          default:
            enabled:     true
            with_layout: true
            lifetime:    120
        </pre>
        <p>
          Off course, only the safe method GET get his call stored in the cache.
          <br />The invalidation is kind of easy too :</p>
        <pre class="brush: php; gutter: false;">
          if ($cache = $this->getContext()->getViewCacheManager())
          {
            $cache->remove('pony/index');
            $cache->remove('pony/show?slug='.$slug);
          }
        </pre>
      </div>
      <div class="symfony2">
        <h3>Symfony2</h3>
				<p>The Symfony2 cache is... HTTP. In fact, there is no full page cache inside Symfony2. Check out 
          the <a href="http://docs.symfony-reloaded.org/guides/cache/http.html">documentation</a> or the code bellow - the tips is
        to use a reverse proxy and to set correctly our HTTP expiration and validation headers. No configuration needed !</p>

        <pre class="brush: php; gutter: false;">
          $response->setPublic();
          $response->setSharedMaxAge(120);
          return $response;
        </pre>

        <p>Our cache proxy will store this ressource for 120 secondes. The downside is that there is no invalidation method.<br />
        So we couple the expiration with a validation method and reduce the expiration time.</p>

        <pre class="brush: php; gutter: false;">
          $response->setPublic();
          $response->setSharedMaxAge(60);
          $response->setETag(\md5(\serialize($pony))); // Should be a method in Pony

          if ($response->isNotModified($request))
          {
              // return the 304 Response immediately
              return $response;
          }
          else
          {
              // do some stuff and return a full response
              $response->setContent(
                  $this->getSerializer($_format)->encode($pony, $_format)
              );
              return $response;
          }
        </pre>
      </div>
      <footer>
        <h3>Conclusion</h3>
				<p>The full page cache of symfony 1 is king of slow, all the framework configuration, plugins, sessions... are loaded on each request.
        Symfony2 fix this issue and is way more performant (I mean, cache proxy > PHP, obvious pony is obvious).</p>
			</footer>
		</article>


	</div>
	<div id="footer-container">
		<footer class="wrapper">
      <p>
        This webpage is <strike>buttyfull</strike> provided by <a href="http://lacot.org/">Xavier Lacot</a> &amp;
        <a href="http://damienalexandre.fr/" onclick="cornify_add();cornify_add();cornify_add();this.onclick='';return false;">Damien Alexandre</a> from <a href="http://www.clever-age.com/">Clever Age</a>,
        and hosted by <a href="http://github.com/">Github</a>.<br />
        For more informations, please visit the official <a href="http://symfony-reloaded.org/">Symfony2</a> and <a href="http://www.symfony-project.org/">symfony</a> websites.
      </p>
      <p>
        Original logo by <a href="http://www.extreme-sensio.com/">Extreme sensio</a>.
      </p>
		</footer>
	</div>

	<!--[if lt IE 7 ]>
	<script src="js/libs/dd_belatedpng.js"></script>
	<script> DD_belatedPNG.fix('img, .png_bg');</script>
	<![endif]-->

  <script type="text/javascript" src="syntaxhighlighter/scripts/shCore.js"></script>
  <script type="text/javascript" src="syntaxhighlighter/scripts/shBrushPhp.js"></script>
  <script type="text/javascript" src="syntaxhighlighter/scripts/shBrushYaml.js"></script>
  <script type="text/javascript" src="syntaxhighlighter/scripts/shBrushXml.js"></script>
  <script type="text/javascript" src="syntaxhighlighter/scripts/shBrushPlain.js"></script>
  <script type="text/javascript">
       SyntaxHighlighter.all()
  </script>

  <script type="text/javascript" src="http://www.cornify.com/js/cornify.js"></script>
</body>
</html>